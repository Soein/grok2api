name: è‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸

on:
  schedule:
    # æ¯å¤© UTC 02:00ï¼ˆåŒ—äº¬æ—¶é—´ 10:00ï¼‰è‡ªåŠ¨åŒæ­¥
    - cron: '0 2 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: é…ç½® Git ç”¨æˆ·
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: åŒæ­¥ä¸Šæ¸¸ chenyme/grok2api
        run: |
          echo "ğŸ”„ å¼€å§‹åŒæ­¥ä¸Šæ¸¸ä»“åº“..."
          git remote add upstream https://github.com/chenyme/grok2api.git || true
          git fetch upstream

          echo "ğŸ“Š ä¸Šæ¸¸æ–°æäº¤ï¼š"
          git log --oneline main..upstream/main | head -10 || echo "æ— æ–°æäº¤"

          echo "ğŸ”€ åˆå¹¶ä¸Šæ¸¸ä»£ç ..."
          if git merge upstream/main --no-edit; then
            echo "âœ… åˆå¹¶æˆåŠŸ"
            git push origin main
            echo "ğŸš€ å·²æ¨é€åˆ° GitHub"
          else
            echo "âŒ åˆå¹¶å¤±è´¥ï¼Œå¯èƒ½æœ‰å†²çª"
            git merge --abort
            exit 1
          fi

      - name: ç”ŸæˆåŒæ­¥æŠ¥å‘Š
        if: success()
        run: |
          echo "## âœ… åŒæ­¥æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ä¸Šæ¸¸ä»“åº“**: chenyme/grok2api" >> $GITHUB_STEP_SUMMARY
          echo "**åŒæ­¥æ—¶é—´**: $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æ–°å¢æäº¤" >> $GITHUB_STEP_SUMMARY
          git log --oneline HEAD~5..HEAD >> $GITHUB_STEP_SUMMARY || true

      - name: åŒæ­¥å¤±è´¥é€šçŸ¥
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'âš ï¸ ä¸Šæ¸¸åŒæ­¥å¤±è´¥ - ' + new Date().toISOString().split('T')[0],
              body: `## åŒæ­¥å¤±è´¥æŠ¥å‘Š\n\n**å¤±è´¥æ—¶é—´**: ${new Date().toISOString()}\n**Workflow è¿è¡Œ**: ${context.payload.repository.html_url}/actions/runs/${context.runId}\n\n### å¯èƒ½åŸå› \n\n- å­˜åœ¨ä»£ç å†²çªéœ€è¦æ‰‹åŠ¨è§£å†³\n- ä¸Šæ¸¸ä»“åº“æš‚æ—¶ä¸å¯è®¿é—®\n- ç½‘ç»œè¿æ¥é—®é¢˜\n\n### å»ºè®®æ“ä½œ\n\n1. æŸ¥çœ‹ [Actions æ—¥å¿—](${context.payload.repository.html_url}/actions/runs/${context.runId}) äº†è§£è¯¦ç»†é”™è¯¯\n2. å¦‚æœæ˜¯å†²çªï¼Œå¯èƒ½éœ€è¦æœ¬åœ°æ‰‹åŠ¨åˆå¹¶\n3. å¦‚æœæ˜¯ä¸´æ—¶æ€§é—®é¢˜ï¼Œå¯ä»¥ç¨åæ‰‹åŠ¨é‡æ–°è§¦å‘ workflow`
            })
